const credentials = require("../config/mailCredentials");
const nodemailer = require("nodemailer");
//const bodyParser = require("body-parser");
//const schedule = require('node-schedule');
const moment = require("moment-timezone");

const dispatcher = async ({
emailBody,
sendAt
}) => {
  const date = moment.utc(sendAt).tz("Europe/Copenhagen");

let transporter = nodemailer.createTransport({
    host: 'smtp.gmail.com',
    port: 465,
 //   pool: true,
    secure: true, // use SSL
    auth: {
        user: credentials.user,
        pass: credentials.pass
    }

});

  // verify connection configuration
  const verification = await transporter.verify();
  console.log(verification && "email account ready");

  // var mailingList =[];
  // mailingList.toString();
  
  const concatEmail = "anna.maria.wilczek@gmail.com";  //username.concat("@simcorp.com");
  email ="anna.maria.wilczek@gmail.com";
  
   // send mail with defined transport object

   const info = await transporter.sendMail({
    from: credentials.user,  //`${email} `, // list of receivers
    to: concatEmail,
    subject: "Adolphine - New reminder delivered",
    html: `
           <p>Dear SimCorper</p>
           
           <p>Here is something worth remembering for you</p>

           <h1>Reminder: ${emailBody}</h1>
          
           <p>Best regards,<br>
           Adolphine<br>
         
           <p>Above message is autogenerated.</p>`,
  });
  transporter.sendMail(function(email,error, info){
    if (error) {
      console.log(error);
    } else {
      console.log('Email sent: ' + email);
    }
  });
  transporter.close();
};

module.exports = dispatcher;


// maillist.forEach(function (to, i , array) {
//     (function(i,to){
//        msg.to = to;
//     transporter.mailSender(msg, function (err) {
//       if (err) { 
//         console.log('Sending to ' + to + ' failed: ' + err);
//         return;
//       } else { 
//         console.log('Sent to ' + to);
//       }
  
//       if (i === maillist.length - 1) { msg.transport.close(); }
//     });
//   })(i,to)
//   });


//consider moving password reset nodemailer here to dispatcher
// mailSender(concatEmail, 'Adolphine - User created succesfully', 
// `A user has just been created using this email. \nIf you did not create this user, please notify us!\n\nKind regards\n Adolhpine`);