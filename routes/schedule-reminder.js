const router = require('express').Router()
const Reminder = require('../db/models/Reminder.js')
const User = require('../db/models/User.js')
const schedule = require('node-schedule')
const nodemailer = require('nodemailer')
const credentials = require('../config/mailCredentials')
const Subscriber = require('../db/models/Subscriber.js')

router.post('/schedule', async(req, res) => {
    const { email_body, send_at } = req.body

    if (email_body && send_at) {
        try {
            const user = await User.query().select('username').where('id', req.session.user.id)

            if (user.length === 1) {

                const createdReminder = await Reminder.query().insert({

                    email_body,
                    created_by: user[0].username,
                    send_at

                })

                console.log(createdReminder)

                schedule.scheduleJob(createdReminder.send_at, function() {
                    console.log('Sending')

                    dispatcher(createdReminder)
                })

                const dispatcher = async() => {
                    const transporter = nodemailer.createTransport({
                        host: 'smtp.gmail.com',
                        port: 465,
                        pool: true,
                        secure: true, // use SSL
                        auth: {
                            user: credentials.user,
                            pass: credentials.pass
                        }

                    })

                    // verify connection configuration
                    await transporter.verify()
                    console.log('Email account ready')

                    const subscribers = await Subscriber.query().select('email')

                    const mailingList = []

                    subscribers.forEach(subscriber => {
                        mailingList.push(subscriber.email)
                    })

                    console.log(subscribers)
                    console.log(createdReminder.email_body)

                    const mailOptions = {

                        from: credentials.user,
                        to: mailingList,
                        subject: 'Adolphine - New reminder delivered',
                        html: `
                             <p>Dear SimCorper,</p>
                             
                             <p>Here is something worth remembering for you</p>
                  
                             <h1>Reminder: ${createdReminder.email_body} </h1>
                            
                             <p>Best regards,<br>
                             Adolphine<br>
                             <p><em><small>Above message is autogenerated. 
                             <a href="http://localhost:5005/delete-subscriber">Unsubscribe<small></em></p>`
                    }

                    transporter.sendMail(mailOptions, (error) => {
                        if (error) {
                            console.log(error)
                            return
                        }
                        console.log('Sent!')
                    })
                }
            }
        } catch (error) {
            return res.status(500).send({ response: 'Something went wrong with the database' + error })
        }
    }
})

module.exports = router