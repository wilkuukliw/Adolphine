const router = require('express').Router();
const path = require('path');
const Reminder = require('../models/Reminder.js');
const User = require('../models/User.js');
const dispatcher = require("../dispatcher/dispatcher.js");
const schedule = require('node-schedule');
const nodemailer = require("nodemailer");


router.get("/schedule", (req, res) => {

 //   if(req.session.user) {
        return res.sendFile(path.join(__dirname, '../api/reminders/add-reminder.html'));
 //   } else {
//        return res.redirect('/login');
 //   }
 });

router.post("/schedule", async (req, res) => {
    const { email_body, created_by, send_at } = req.body;

    //consider not to ask for credentials but fetch them from session instead

    if (email_body && created_by && send_at) {

        try {
            const userFound = await User.query().select().where('username', created_by).limit(1);
            if (userFound.length === 0) {
                return res.status(400).send({ response: "Verify the user's initials"
                });
                
            } else {

            const createdReminder = await Reminder.query().insert({

                email_body,
                created_by,
                send_at

            });

            console.log(createdReminder);

                schedule.scheduleJob(createdReminder.send_at,  function(){
                console.log("Sending");

                dispatcher(createdReminder);   
            })
       
            //first show alert and then redirect

        }
    } catch (error) {
        return res.status(500).send({ response: "Something went wrong with the database" + error});

    }}});


 

module.exports = router;


//const Subscriber = require('../models/Subscriber.js');



// const dispatcher = async ({
// emailBody,
// sendAt
// }) => {
//   moment.utc(sendAt).tz("Europe/Copenhagen");

// let transporter = nodemailer.createTransport({
//     host: 'smtp.gmail.com',
//     port: 465,
//     pool: true,
//     secure: true, // use SSL
//     auth: {
//         user: credentials.user,
//         pass: credentials.pass
//     }

// });


//   // verify connection configuration
//    await transporter.verify();
//   console.log("email account ready");



//   // get emails from database
// //var mailingList =["anna.maria.wilczek@gmail.com", "anna.wilczek@student.uw.edu.pl", "anwi@simcorp.com" ];
//  //mailingList.toString();
  
//   const concatEmail = "anna.maria.wilczek@gmail.com";  //username.concat("@simcorp.com");
//  // email ="anna.maria.wilczek@gmail.com";

 
  
//    // send mail with defined transport object

//   //  const subscribers = async () => {
//   //   await Subscriber.query().select();
//   //   console.log(subscribers);
//   // };



//    const info = await transporter.sendMail({
//     from: credentials.user,  //`${email} `, // list of receivers
//     to: concatEmail,
//     subject: "Adolphine - New reminder delivered",
//     html: `
//            <p>Dear SimCorper</p>
           
//            <p>Here is something worth remembering for you</p>

//            <h1>Reminder: ${emailBody}</h1>
          
//            <p>Best regards,<br>
//            Adolphine<br>
//            <p><input type="text" value="Above message is autogenerated." disabled /> </p>`,
//   });
  
// };
